name: Daily Repository Analysis

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of repositories to analyze in this batch'
        required: false
        default: '5'
        type: string

jobs:
  daily-analysis:
    name: Daily Analysis Batch
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: cli/package-lock.json
        
    - name: Install CLI dependencies
      working-directory: cli
      run: npm ci
      
    - name: Build CLI
      working-directory: cli
      run: npm run build
      
    - name: Check repository statistics
      working-directory: cli
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "üìä Repository Statistics:"
        node dist/index.js analyze-missing --dry-run --limit 1 || true
        
    - name: Run daily analysis batch
      working-directory: cli
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        BATCH_SIZE="${{ github.event.inputs.batch_size || '5' }}"
        
        echo "üöÄ Starting daily analysis batch (${BATCH_SIZE} repositories)"
        echo "‚è∞ Started at: $(date)"
        
        # Run with conservative settings
        node dist/index.js analyze-missing \
          --limit "${BATCH_SIZE}" \
          --delay 10000
          
        echo "‚úÖ Daily analysis batch completed at: $(date)"
        
    - name: Summary report
      if: always()
      working-directory: cli
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "üìà Post-analysis statistics:"
        node dist/index.js analyze-missing --dry-run --limit 1 || true